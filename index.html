<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Smart Jar Command Dashboard</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <style>
    body {
      background: #0f172a;
      color: #e2e8f0;
      font-family: sans-serif;
      padding: 20px;
      line-height: 1.5;
    }
    h1, h2 {
      color: #60a5fa;
    }
    section {
      margin-bottom: 30px;
      padding: 15px;
      background-color: #1e293b;
      border-radius: 10px;
    }
    .btn {
      padding: 10px 20px;
      margin: 5px 5px 5px 0;
      background-color: #1e40af;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .btn:hover {
      background-color: #2563eb;
    }
    input {
      padding: 8px;
      margin: 5px;
      border-radius: 4px;
      border: none;
    }
    #log {
      margin-top: 10px;
      padding: 10px;
      background: #0f172a;
      height: 350px;
      overflow-y: auto;
      white-space: pre-wrap;
      font-family: monospace;
      border-radius: 5px;
      border: 1px solid #334155;
    }
    .tx { color: #4ade80; }    /* Green */
    .rx { color: #facc15; }    /* Yellow */
    .err { color: #f87171; }   /* Red */
    .json { color: #93c5fd; }  /* Light blue */
    .warn { color: #f87171; font-weight: bold; }
  </style>
</head>
<body>

  <h1>📦 Smart Jar Command Dashboard</h1>

  <!-- SENSOR READING -->
  <section>
    <h2>📊 Sensor Readings</h2>
    <button class="btn" onclick="sendCmd('DATA')">🔍 Get Data</button>
  </section>

  <!-- INGREDIENT LEARNING -->
  <section>
    <h2>🧠 Learn New Ingredient</h2>
    <input type="text" id="learnInput" placeholder="Enter ingredient name" />
    <button class="btn" onclick="sendLearn()">🧠 Learn</button>
  </section>

  <!-- LOAD CELL CALIBRATION -->
  <section>
    <h2>⚖️ Load Cell Calibration</h2>
    <input type="number" id="calInput" placeholder="Known weight (g)" />
    <button class="btn" onclick="sendCal()">⚙️ Calibrate</button>
    <button class="btn" onclick="sendCmd('TARE')">🎯 Tare</button>
  </section>

  <!-- PROFILE MANAGEMENT -->
  <section>
    <h2>📂 Profile Management</h2>
    <button class="btn" onclick="sendCmd('LIST')">📋 List Profiles</button>
    <button class="btn" onclick="sendCmd('RESET')">🔁 Load Profiles</button>
    <button class="btn" onclick="sendCmd('ERASE')">🧹 Erase All</button>
  </section>

  <!-- DEBUG CONSOLE -->
  <section>
    <h2>🛠️ Debug Console</h2>
    <div id="log">Connecting to MQTT...</div>
  </section>

  <script>
    const options = {
      clean: true,
      connectTimeout: 4000,
      clientId: "WebDashboard_" + Math.random().toString(16).substr(2, 8),
      username: "bharadwaj",
      password: "IoTtest1"
    };

    const mqttUrl = "wss://e7ffb68b7a584515a2243f84fac41ca7.s1.eu.hivemq.cloud:8884/mqtt";
    const client = mqtt.connect(mqttUrl, options);

    const statusTopic = "smartjar/status";
    const dataTopic = "smartjar/data";
    const cmdTopic = "smartjar/cmd";

    function log(message, cssClass = "") {
      const logDiv = document.getElementById("log");
      const time = new Date().toLocaleTimeString();
      const line = document.createElement("div");
      line.className = cssClass;
      line.textContent = `[${time}] ${message}`;
      logDiv.appendChild(line);
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    client.on("connect", () => {
      log("✅ Connected to MQTT broker", "tx");
      client.subscribe(statusTopic, () => log(`📩 Subscribed to ${statusTopic}`, "tx"));
      client.subscribe(dataTopic, () => log(`📩 Subscribed to ${dataTopic}`, "tx"));
    });

    client.on("message", (topic, payload) => {
      let message = payload.toString();

      if (topic === statusTopic) {
        log(`🟡 RX ← ${topic}: ${message}`, "rx");

      } else if (topic === dataTopic) {
        try {
          // Replace unquoted inf with quoted "inf"
          message = message.replace(/:\s*inf/g, ':"inf"');

          const json = JSON.parse(message);
          log(`🟡 RX ← ${topic} (parsed JSON):`, "rx");
          log(JSON.stringify(json, null, 2), "json");

          const rsValue = (json.rs === "inf") ? "∞ (open)" : json.rs;
          const ingClass = (json.ingredient === "Unknown") ? "warn" : "rx";
          const rsClass = (json.rs === "inf") ? "warn" : "rx";

          const info = `📦 INGREDIENT: ${json.ingredient}
➤ Confidence: ${json.confidence}
➤ Weight: ${json.weight} g
➤ Temp: ${json.temperature}°C
➤ Humidity: ${json.humidity}%
➤ Air: ${json.air}
➤ RS: ${rsValue}
➤ Spectral: [${json.spectral.map(v => v.toFixed(3)).join(", ")}]`;

          log(info, (json.ingredient === "Unknown" || json.rs === "inf") ? "warn" : "rx");

        } catch (e) {
          log(`❌ JSON Parse Error on ${topic}:\n${message}`, "err");
        }
      } else {
        log(`❓ Unknown topic ${topic}:\n${message}`, "err");
      }
    });

    function sendCmd(cmd) {
      client.publish(cmdTopic, cmd);
      log(`🟢 TX → ${cmdTopic}: ${cmd}`, "tx");
    }

    function sendLearn() {
      const name = document.getElementById("learnInput").value.trim();
      if (name) {
        sendCmd(`LEARN:${name}`);
      } else {
        alert("Enter a valid ingredient name.");
      }
    }

    function sendCal() {
      const weight = document.getElementById("calInput").value.trim();
      if (weight && !isNaN(weight)) {
        sendCmd(`CAL:${weight}`);
      } else {
        alert("Enter a valid weight in grams.");
      }
    }
  </script>

</body>
</html>
